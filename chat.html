<!doctype html>
<html>
  <head>
    <title>Secret Messenger</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/style">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
	//If cookie is not set, redirect to index
    if(document.cookie.length==0){
    	window.location='/';
    }
    
    //Parse variables from cookie data
    var sn = '';
    var ucolor = '';
    var secret = '';
    var dough = document.cookie.split(';');
    for(i=0;i<dough.length;i++){
    	chip = dough[i].split('=');
    	if(chip[0].includes('sn')){
    		sn = chip[1];
    	} else if(chip[0].includes('ucolor')){
    		ucolor = chip[1];
    	} else if(chip[0].includes('secret')){
    		secret = chip[1];
    	};
    }
    
	//Initialize toggle variable
    var toggle = 0;
    
	//Toggle encryption off
    function show() {
    	var convo = $('.msg');
    	convo.each(function(i){
    		var thisLine = this;
			var messg = $(this).text();
			var resp = '';
			$.ajax({url: '/decrypt', 
				type: 'post',
				data: {
					key: secret,
					msg: messg
				}
			}).done(function (data) {
				$(thisLine).text(data);
			})
		});
		toggle = 1;
	}
	
	//Toggle encryption on
	function hide() {
    	var convo = $('.msg');
    	convo.each(function(i){
    		var thisLine = this;
			var messg = $(this).text();
			var resp = '';
			$.ajax({url: '/encrypt', 
				type: 'post',
				data: {
					key: secret,
					msg: messg
				}
			}).done(function (data) {
				$(thisLine).text(data);
			})
		});
		toggle = 0;
	}
    </script>
  </head>
  <body>
	<div><button onclick="if(toggle==0){show()} else{hide()}">Toggle Encryption</button></div>
    <ul id="messages"></ul>
    <form action="" id="entry">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    
    <script>  
	//Socket chat client function
    $(function () {
		var socket = io('/<%=id%>');
		$('form').submit(function(){
			socket.emit('<%=id%>', $('#m').val());
			$('#m').val('');
			return false;
		});
		socket.on('<%=id%>', function(msg){
		if(toggle==0){
			$('#messages').append($('<li style="background:'+msg.ucolor+'">'+msg.sn+': <span class="msg">'+msg.crypted+'</span>'));
		} else if(toggle==1){
			$('#messages').append($('<li style="background:'+msg.ucolor+'">'+msg.sn+': <span class="msg">'+msg.raw+'</span>'));
		};
			
			window.scrollTo(0, document.body.scrollHeight);
		});
	});
    
      
    </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  </body>
</html>
