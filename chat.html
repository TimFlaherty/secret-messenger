<!doctype html>
<html lang="en">
  <head>
    <title>Secret Messenger</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/style">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.2.0/socket.io.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
	//If cookie is not set, redirect to index
    if(document.cookie.length==0){
    	window.location='/';
    }
    
    //Parse variables from cookie data
    var sn = '';
    var ucolor = '';
    var secret = '';
    var dough = document.cookie.split(';');
    for(i=0;i<dough.length;i++){
    	chip = dough[i].split('=');
    	if(chip[0].includes('sn')){
    		sn = chip[1];
    	} else if(chip[0].includes('ucolor')){
    		ucolor = chip[1];
    	} else if(chip[0].includes('secret')){
    		secret = chip[1];
    	};
    }
    
	//Initialize toggle variable
    var toggle = 0;
    
    //Arrays to store chat messages
    var chatray = [];
    var nochatray = [];
    
	//Toggle encryption off
    function show() {
    	var convo = $('.msg');
    	convo.each(function(i){
    		$(this).text(chatray[i]);
		});
		toggle = 1;
	}
	
	//Toggle encryption on
	function hide() {
    	var convo = $('.msg');
    	convo.each(function(i){
    		$(this).text(nochatray[i]);
		});
		toggle = 0;
	}
	
	//Converts hex color values to RGB
	function hexToRgb(hex) {
		var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
		return result
		? [
			parseInt(result[1], 16),
			parseInt(result[2], 16),
			parseInt(result[3], 16)
		]
		: [0, 0, 0];
	}
	
	//Selects black or white text based on hex color input
	function lum(hex) {
		var rgb = hexToRgb(hex)
		var lrgb = [];
		rgb.forEach(function(c) {
			c = c / 255.0;
			if (c <= 0.03928) {
				c = c / 12.92;
			} else {
				c = Math.pow((c + 0.055) / 1.055, 2.4);
			}
			lrgb.push(c);
		});
		var lum = 0.2126 * lrgb[0] + 0.7152 * lrgb[1] + 0.0722 * lrgb[2];
		return lum > 0.179 ? "#000000" : "#ffffff";
	}
	
	//Socket chat client function
    $(function () {
		var socket = io('/<%=id%>');
		
		$('form').submit(function(){
			socket.emit('<%=id%>', $('#m').val());
			$('#m').val('');
			return false;
		});
		
		//Emits greeting on new user connection
		socket.on('hello', function(msg){	
			var textColor = lum(msg.ucolor);
			$('#messages').append($('<li style="background:'+msg.ucolor+';color:'+textColor+'">'+msg.greeting+'</li>'));
		});
		
		//Emits user messages, controls encryption
		socket.on('<%=id%>', function(msg){		
			chatray.push(msg.raw);
			nochatray.push(msg.crypted);
			var textColor = lum(msg.ucolor);
			var message;
			if(toggle==0){
				message=msg.crypted;
			} else if(toggle==1){
				message=msg.raw;
			};
			$('#messages').append($('<li style="background:'+msg.ucolor+';color:'+textColor+'">'+msg.sn+': <span class="msg">'+message+'</span></li>'));
			window.scrollTo(0, document.body.scrollHeight);
		});
	});
    </script>
  </head>
  <body>
	<div><button class="form-control btn btn-secondary" onclick="if(toggle==0){show()} else{hide()}">Toggle Encryption</button></div>
    <ul id="messages"></ul>
    <form id="entry">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  </body>
</html>
